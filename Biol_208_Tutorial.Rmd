---
title: "208_Tutorial"
author: "Megan, Justin, Katie E"
date: "1/29/2019"
output: html_document
---

Welcome to R coding in 208!
We will be providing a walkthrough of general R skills including: package loading, data visualization using ggplot2, and data analysis. Additionally we will introduce several packages that can aid in investigation of specific 208 topics and questions. This tutorial is split into three parts:
  Part 1 - R review
  Part 2 - Shannon-Diversity Index
  Part 3 - Survivorship Curves


#Part 1: R Review
In this part, we will cover how to install data visualization packages and use those to analyze data to test hypotheses.

We will be using ggplot2 and UsingR, and we can install both using this chunk of code. The install.packages function installs the package and the library function makes sure the package is "turned on" once you have it in R.
```{r}
if (!require("ggplot2")) install.packages("ggplot2"); library(ggplot2)
if (!require("UsingR")) install.packages("UsingR"); library(UsingR)
```

Datasets shows your entire data table. Head shows the first five lines and tail shows the last five lines. Running both are useful to make sure your data is complete and each column has the same number of rows. Summary will provide the five number summary for each variable in the data set and will let you know if there is any missing data ("NA"s).

```{r setup, include=TRUE}
library(ggplot2)
datasets::iris
head(iris)
tail(iris)
summary(iris)
```

Before running any other tests or visual analyses of your data, you should generate a hypothesis. In this example we will be testing the hypothesis the longer sepal lengths will generate longer petal lengths. To test this we should first create subsets of the data for each species.

```{r Subset}
setosa <- subset(iris,Species == "setosa")
versicolor <- subset(iris,Species == "versicolor")
virginica <- subset(iris,Species == "virginica")
```

Next, since these variables are quantitative, you want to run the simple.eda function on each variable from the main data set not the subsets. This function will display a histogram, boxplot, and QQ plot for each subset. If the points follow the diagonal line in the QQ plot, then the data is normally distributed.

```{r simple.eda}
simple.eda(iris$Sepal.Length)
simple.eda(iris$Petal.Length)
```

To look at the distribution of species we will use a bar graph and a table, since it is a categorical variable.

```{r bar graph}
ggplot(iris) + 
  aes(x=factor(Species)) +
  geom_bar() +
  theme_classic() +
  xlab ("species")
```
```{r}
table(iris$Species)
```


You can also use pie charts to display categorical data. However, due to the inability to tell differences in the sizes of each wedge of the pie, they are usually not used. Bar graphs and tables are much more useful in displaying the distribution of a categorical variable.

Next you run a shapiro test for each variable to determine if that varibale is actually normally distributed since it is sometimes hard to tell from the QQ plots.

```{r}
shapiro.test(iris$Sepal.Length)
shapiro.test(iris$Petal.Length)
```
Since both p-values are less than 0.05 we reject the null hypothesis that the data comes from samples that are normally distrubted so we have to transform the data.

```{r}
simple.eda(log10(iris$Sepal.Length))
simple.eda(log10(iris$Petal.Length))
shapiro.test(log10(iris$Sepal.Length))
shapiro.test(log10(iris$Petal.Length))
```
Since in the end petal length was not normally distributed we will create a scatterplot to help us visualize the data, but to determine if there is a signifcant effect we will have to run a mann whitney u test. 

```{r}
ggplot(iris, aes(x=Sepal.Length, y =Petal.Length))+
  geom_point(aes(colour = factor(Species)), shape =1, size=3)+
  theme_classic() +
  geom_smooth(method=lm, color="blue", se=TRUE)+
  xlab("Sepal Length")+
  ylab("Petal Length")+
  ylim(0,8)+
  labs(color = "Species")
```

The following chunk of code is how to test if there is a significant relationship found in non parametric (data that isnt normally distirbuted) data.We will use the subsetted data for this test as we want to test the relationship for each species.

```{r}
wilcox.test(setosa$Petal.Length, setosa$Sepal.Length)
wilcox.test(versicolor$Petal.Length, versicolor$Sepal.Length)
wilcox.test(virginica$Petal.Length, virginica$Sepal.Length)
```
Since all three p-values are less than 0.05 this means that for each species sepal length affects petal length.There were other variables in the data set for Iris. Pick different variables, create your own hypothesis, and explore and test the significane of the data.

We can also use R to investigate and explore other datasets, as well as answer different types of questions.


We can also use R to investigate and explore other datasets, as well as answer different types of questions. For example, we can use R to investigate diversity. One measure of diversity we learn about in 208 is the Shannon Diversity index. Conveniently, there is a package in R (vegan) specifically designed to calculate not only the Shannon Diversity index, but to also investigate other measures of diversity.


#Part II: Shannon Diversity Index
```{r Shannon-diversity index}

#first need to install vegan

#load vegan 
library(vegan)

#Using a preloaded dataset BCI
data("BCI")

#look at BCI dataset
BCI

#investigate this dataset
ncol(BCI)
colnames(BCI)
nrow(BCI)
rownames(BCI)

#Two different ways to get shannon-diversity index for each site
diversity(BCI)

#This second method is more complex, but allows us to choose other possible indices to use instead of Shannon. Here we are going to assign our calculation to a new dataset labelled diversity_dataset
diversity_dataset <- diversity(BCI, index= "shannon", MARGIN = 1, base = exp(1))
diversity_dataset

#checking the normality of this data
qqnorm(diversity_dataset)
qqline(diversity_dataset)

#using a histogram to look at data
hist(diversity_dataset)

#investigate diversity_dataset
plot(diversity_dataset)
summary(diversity_dataset)

#getting the median diversity
median(diversity_dataset)

#getting the average diversity
mean(diversity_dataset)

#Creating a species accumulation curve. Species accumulation curves allow us to visualize how many species are present for a certain number of sites. Among other functions, it allows us to determine if species count is increasing with sampling effort (number of sites).
species_accumulation <- specaccum(BCI)

#Plotting a basic species accumulation curve
plot(species_accumulation) 

#We can edit this graph to better visualize the data, and to be generally more visually appealing 
#Aesthetics include:
#ci.type = bar, line, or polygon; Type of confidence interval drawn on the figure. 
#col=""; color of species accumulation line
#lwd= ; width of line
#ci.lty= 0,1,2,3... ; Type of border on confidence polygon or confidence lines
#ci.col=""; color for confidence line or polygon
#ylab= "" ; this allows us to edit the label on the y axis
plot(species_accumulation, ci.type="poly", col="blue", lwd=3, ci.lty=0, ci.col="orange", ylab ="Species Accumulation") 
```

  
---------- KE

```{r}
## Load survival package
library(survival)
## List datasets in survival package
data(package = "survival")

## Load lung data
data(lung)

## Show first 6 rows
head(lung)
```

```{r}
## Add survival object
lung$SurvObj <- with(lung, Surv(time, status == 2))

## Check data
head(lung)
```


```{r}
## Kaplan-Meier estimator. The "log-log" confidence interval is preferred.
km.as.one <- survfit(SurvObj ~ 1, data = lung, conf.type = "log-log")
km.by.sex <- survfit(SurvObj ~ sex, data = lung, conf.type = "log-log")

## Show object
km.as.one
survfit(formula = SurvObj ~ 1, data = lung, conf.type = "log-log")

km.by.sex
survfit(formula = SurvObj ~ sex, data = lung, conf.type = "log-log")

## See survival estimates at given time (lots of outputs)
## summary(km.as.one)
## summary(km.by.sex)

## Plotting without any specification
plot(km.as.one)
plot(km.by.sex)
```

```{r}
## Load rms package
install.packages(rms)
library(rms)

## without specification
#survplot(km.by.sex)
```

```{r}
## Without dots
survplot(fit  = km.by.sex,
         conf = c("none","bands","bars")[1],
         xlab = "", ylab = "Survival",
         ## xlim(0,100),
         label.curves = TRUE,                     # label curves directly
         ## label.curves = list(keys = "lines"),  # legend instead of direct label
         abbrev.label = FALSE,                    # if label used, abbreviate
         ## fun = function(x) {1 - x},            # Cumulative probability plot         
         loglog   = FALSE,                        # log(-log Survival) plot
         logt     = FALSE,                        # log time
         time.inc = 100,                          # time increment
         dots     = FALSE,                         # dot grid
         n.risk   = TRUE,                         # show number at risk
         ## srt.n.risk = 0, sep.n.risk = 0.056, adj.n.risk = 1,
         ## y.n.risk = 0, cex.n.risk = 0.6
         )


#https://rstudio-pubs-static.s3.amazonaws.com/5588_72eb65bfbe0a4cb7b655d2eee0751584.html
```




-------


- upload data from an excel file 
  - install readxl
  
```{r Upload Data }
install.packages("readxl")
library(readxl)
library(ggplot2)
library(cowplot)


demographyData <- read_excel("BIO208_Demog_Calcs_Master.xlsx")
View(demographyData)

```


- subset into groups based on year and sex

```{r Subsets}
fpre1840 <- subset(demographyData, select = "Pre-1840 Female")
mpre1840 <- subset(demographyData, select = "Pre-1840 Male")

```


- calculate proportion alive for each age class


```{r Functions}

#function that calculates the number of people still alive
numStillAlive <- function(subset1) { 
  totalStartAlive <- sum(subset1)
  for (i in row(subset1)){
    sumDead <- sum(subset1[1:i,1])
    stillAlive <- totalStartAlive - sumDead
    listStillAlive <- c(listStillAlive,stillAlive)
  }
  return(listStillAlive)
}


proportionAlive <- function(dataframe) {
  for (i in col(dataframe)) {
    a <- dataframe[i]/dataframe[1]
    list <- c(list,a)
  }
  return(list)
}


```


```{r Calculate Proportions}
fpre1840alive <- as.data.frame(numStillAlive(fpre1840))
fpre1840prop <- proportionAlive(fpre1840alive)
fpre1840$PropAlive <- fpre1840prop[2:21]
fpre1840$xAxis <- 1:20

mpre1840alive <- as.data.frame(numStillAlive(mpre1840))
mpre1840prop <- proportionAlive(mpre1840alive)
mpre1840$PropAlive <- mpre1840prop[2:21]
mpre1840$xAxis <- ("0-5" "6-10" "11-15" "16-20" "21-25" "26-30" "31-35" "36-40" "41-45" "46-50" "51-55" "56-60" "61-65" "66-70" "71-75""76-80" "81-85" "86-90" "91-95" "96+")
mpre1840$xAxis <- (0-5 6-10 11-15)


```


- plot survivorship curve

```{r Plot Survivorship}
ggplot(fpre1840) +
  aes(x = as.numeric(xAxis), y = as.numeric(PropAlive)) +
  geom_line() +
  theme_cowplot() +
  xlab("Days with enough sleep to feel rested (last 7 days)") + 
  ylab("Survivorship")

```


Trouble shooting:
1.) 

